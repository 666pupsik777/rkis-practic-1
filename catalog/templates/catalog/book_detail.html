{% extends "base_generic.html" %}
{% load static %}

<!DOCTYPE html>
<html lang="ru">
<head>
    {% block title %}<title>{{ book.title }} - Local Library</title>{% endblock %}
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="{% static 'css/styles.css' %}" />
</head>

{% block content %}
<div class="book-detail-container">
    <!-- Заголовок и основная информация -->
    <header class="book-header">
        <div class="book-title-section">
            <h1 class="book-title">
                <i class="fas fa-book"></i>
                {{ book.title }}
            </h1>
            <div class="book-meta">
                <span class="copies-count">
                    <i class="fas fa-copy"></i>
                    {{ book.bookinstance_set.count }} экземпляров
                </span>
            </div>
        </div>
    </header>

    <!-- Основная информация о книге -->
    <div class="book-content">
        <div class="book-main-info">
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-user-edit"></i>
                        Автор
                    </div>
                    <div class="info-value">
                        <a href="{% url 'author-detail' book.author.pk %}" class="author-link">
                            {{ book.author }}
                        </a>
                    </div>
                </div>

                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-barcode"></i>
                        ISBN
                    </div>
                    <div class="info-value isbn-code">{{ book.isbn }}</div>
                </div>

                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-language"></i>
                        Язык
                    </div>
                    <div class="info-value">
                        <span class="language-tag">{{ book.language }}</span>
                    </div>
                </div>

                <div class="info-item full-width">
                    <div class="info-label">
                        <i class="fas fa-tags"></i>
                        Жанры
                    </div>
                    <div class="genres-container">
                        {% for genre in book.genre.all %}
                        <span class="genre-tag">{{ genre }}</span>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Описание книги -->
            {% if book.summary %}
            <div class="summary-section">
                <div class="section-header">
                    <i class="fas fa-file-alt"></i>
                    Описание
                </div>
                <div class="summary-content">
                    {{ book.summary }}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Боковая панель -->
        <aside class="book-sidebar">
            <!-- Статус доступности -->
            <div class="status-card">
                <div class="status-header">
                    <i class="fas fa-info-circle"></i>
                    Статус доступности
                </div>
                <div class="status-content">
                    {% with available_copies=book.bookinstance_set.all|filter_status:"a" %}
                    <div class="availability-indicator {% if available_copies %}available{% else %}unavailable{% endif %}">
                        <div class="status-icon">
                            {% if available_copies %}
                            <i class="fas fa-check-circle"></i>
                            {% else %}
                            <i class="fas fa-times-circle"></i>
                            {% endif %}
                        </div>
                        <div class="status-text">
                            <h3>{% if available_copies %}Доступна{% else %}Не доступна{% endif %}</h3>
                            <p>
                                {% if available_copies %}
                                {{ available_copies|length }} копий доступно
                                {% else %}
                                Все копии выданы
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    {% endwith %}
                </div>
            </div>

            <!-- Действия -->
            <div class="actions-card">
                <div class="actions-header">
                    <i class="fas fa-bolt"></i>
                    Действия
                </div>
                <div class="actions-content">
                    {% if perms.catalog.can_mark_returned %}
                    <a href="{% url 'book_update' book.pk %}" class="action-btn edit-btn">
                        <i class="fas fa-edit"></i>
                        Редактировать
                    </a>
                    {% endif %}

                    {% if user.is_authenticated %}
                    <a href="{% url 'reserve-book' %}?book={{ book.pk }}" class="action-btn reserve-btn">
                        <i class="fas fa-bookmark"></i>
                        Забронировать
                    </a>
                    {% endif %}

                    <a href="{% url 'books' %}" class="action-btn back-btn">
                        <i class="fas fa-arrow-left"></i>
                        Назад к списку
                    </a>
                </div>
            </div>
        </aside>
    </div>

    <!-- Секция с экземплярами -->
    <section class="copies-section">
        <div class="section-header">
            <i class="fas fa-copy"></i>
            Экземпляры книги
        </div>

        {% if book.bookinstance_set.all %}
        <div class="copies-list">
            {% for copy in book.bookinstance_set.all %}
            <div class="copy-card {% if copy.status == 'a' %}status-available{% elif copy.status == 'd' %}status-reserved{% else %}status-maintenance{% endif %}">
                <div class="copy-header">
                    <div class="copy-status">
                        <span class="status-badge {% if copy.status == 'a' %}available{% elif copy.status == 'd' %}reserved{% else %}maintenance{% endif %}">
                            <i class="fas {% if copy.status == 'a' %}fa-check-circle{% elif copy.status == 'd' %}fa-times-circle{% else %}fa-clock{% endif %}"></i>
                            {{ copy.get_status_display }}
                        </span>
                    </div>

                    {% if perms.catalog.can_mark_returned and copy.status != 'a' %}
                    <a href="{% url 'renew-book-librarian' copy.id %}" class="renew-btn">
                        <i class="fas fa-redo-alt"></i>
                        Продлить
                    </a>
                    {% endif %}
                </div>

                <div class="copy-details">
                    {% if copy.status != 'a' %}
                    <div class="detail-item">
                        <label>К возврату подлежат:</label>
                        <span class="due-date {% if copy.is_overdue %}overdue{% endif %}">
                            {{ copy.due_back }}
                            {% if copy.is_overdue %}
                            <i class="fas fa-exclamation-triangle warning-icon"></i>
                            {% endif %}
                        </span>
                    </div>
                    {% endif %}

                    {% if copy.imprint %}
                    <div class="detail-item">
                        <label>Издательство:</label>
                        <span>{{ copy.imprint }}</span>
                    </div>
                    {% endif %}

                    <div class="detail-item">
                        <label>ID экземпляра:</label>
                        <code class="copy-id">{{ copy.id }}</code>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-copies">
            <i class="fas fa-book-open"></i>
            <h3>Нет доступных экземпляров</h3>
            <p>Все копии этой книги в настоящее время недоступны</p>
        </div>
        {% endif %}
    </section>
</div>

{% endblock %}